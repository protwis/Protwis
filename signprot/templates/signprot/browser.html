{% extends "home/base.html" %}
{% load staticfiles %}

{% block content %}
<a id="dlink"  style="display:none;"></a>
<input type="button" onclick="tableToExcel('couplings', 'Coupling data', 'MyFile.xls')" value="Export to Excel">

<table class="table table-bordered" id="couplings">
    <thead>
        <tr>
            <th>
                Class
            </th>
            <th colspan=2>
                Receptor
            </th>
            <th colspan="4">
                G protein coupling (merged sources)
            </th>
            <th colspan="4">
                <a href="http://www.guidetopharmacology.org/GRAC/ReceptorFamiliesForward?type=GPCR">Guide To Pharmacology database</a>
            </th>
            <th colspan="4">
                Asuka Inoue et al., Cell 2019
            </th>
            <th colspan="4">
                Gi/o
            </th>
            <th colspan="3">
                Gq/11
            </th>
            <th colspan="2">
                G12/13
            </th>
            <th colspan="2">
                Gs
            </th>
        </tr>
        <tr>
            <th>
            </th>
            <th>
            </th>
            <th>
            </th>
            {% for gf in distinct_gf %}
                <th></th>
            {% endfor %}
            {% for gf in distinct_gf %}
                <th></th>
            {% endfor %}
            {% for gf in distinct_gf %}
                <th></th>
            {% endfor %}
            {% for gf,sfs in distinct_sf.items %}
                {% for sf in sfs %}
                    <th>{{sf}}</th>
                {% endfor %}
            {% endfor %}
        </tr>

    </thead>

    <tbody>
{% for p,vals in data.items %}
    <tr>
        {% for v in vals %}

        <td{% if forloop.counter0 > 14 %} class="greyscale"{% endif %}>{{v|safe}}</td>
        {% endfor %}
    </tr>
{% endfor %}
    </tbody>
    </table>

{% endblock %}

{% block addon_js %}
    <script src="{% static 'home/js/jquery.dataTables.min.js' %}"> </script>
    <script src="{% static 'home/js/jquery.dataTables.yadcf.js' %}"> </script>
    <script src="{% static 'home/js/select2.js' %}"> </script>
    <script type="text/javascript">
        $(document).ready(function() {
            oTable = $('#couplings').DataTable({
                    'scrollX': true,
                    // 'paging': true,
                    // 'autoWidth': true,

                    scrollY:        '70vh',
                    // scrollCollapse: true,
                    paging:         false,
                    columnDefs: [
                      { targets: 'no-sort', orderable: false }
                    ],
                  });

                  yadcf.init(oTable,
                    [   
                        {
                            column_number : 0,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "Class",
                            filter_reset_button_text: false,
                        },
                        {
                            column_number : 1,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "Uniprot",
                            filter_reset_button_text: false,
                        },
                        {
                            column_number : 2,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            //column_data_type: "html",
                            html_data_type: "text",
                            filter_default_label: "NC-IUPHAR",
                            filter_match_mode : "exact",
                            filter_reset_button_text: false,
                        },

                        {
                            column_number : 3,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "Gq/G11",
                            filter_reset_button_text: false,
                        },


                        {
                            column_number : 4,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "Gi/Go",
                            filter_reset_button_text: false,
                        },


                        {
                            column_number : 5,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "Gs",
                            filter_reset_button_text: false,
                        },


                        {
                            column_number : 6,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "G12/G13",
                            filter_reset_button_text: false,
                        },

                        {
                            column_number : 7,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "Gq/G11",
                            filter_reset_button_text: false,
                        },


                        {
                            column_number : 8,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "Gi/Go",
                            filter_reset_button_text: false,
                        },


                        {
                            column_number : 9,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "Gs",
                            filter_reset_button_text: false,
                        },


                        {
                            column_number : 10,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "G12/G13",
                            filter_reset_button_text: false,
                        },

                        {
                            column_number : 11,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "Gq/G11",
                            filter_reset_button_text: false,
                        },


                        {
                            column_number : 12,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "Gi/Go",
                            filter_reset_button_text: false,
                        },


                        {
                            column_number : 13,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "Gs",
                            filter_reset_button_text: false,
                        },


                        {
                            column_number : 14,
                            filter_type: "multi_select",
                            select_type: 'select2',
                            filter_default_label: "G12/G13",
                            filter_reset_button_text: false,
                        },


                        {
                            column_number : 15,
                            filter_type: "range_number",
                            filter_default_label: ["From", "To"],
                            filter_reset_button_text: false,
                        },

                        {
                            column_number : 16,
                            filter_type: "range_number",
                            filter_default_label: ["From", "To"],
                            filter_reset_button_text: false,
                        },

                        {
                            column_number : 17,
                            filter_type: "range_number",
                            filter_default_label: ["From", "To"],
                            filter_reset_button_text: false,
                        },

                        {
                            column_number : 18,
                            filter_type: "range_number",
                            filter_default_label: ["From", "To"],
                            filter_reset_button_text: false,
                        },

                        {
                            column_number : 19,
                            filter_type: "range_number",
                            filter_default_label: ["From", "To"],
                            filter_reset_button_text: false,
                        },

                        {
                            column_number : 20,
                            filter_type: "range_number",
                            filter_default_label: ["From", "To"],
                            filter_reset_button_text: false,
                        },

                        {
                            column_number : 21,
                            filter_type: "range_number",
                            filter_default_label: ["From", "To"],
                            filter_reset_button_text: false,
                        },

                        {
                            column_number : 22,
                            filter_type: "range_number",
                            filter_default_label: ["From", "To"],
                            filter_reset_button_text: false,
                        },

                        {
                            column_number : 23,
                            filter_type: "range_number",
                            filter_default_label: ["From", "To"],
                            filter_reset_button_text: false,
                        },

                        {
                            column_number : 24,
                            filter_type: "range_number",
                            filter_default_label: ["From", "To"],
                            filter_reset_button_text: false,
                        },

                        {
                            column_number : 25,
                            filter_type: "range_number",
                            filter_default_label: ["From", "To"],
                            filter_reset_button_text: false,
                        },

                        // {
                        //     column_number : 1,
                        //     filter_type: "multi_select",
                        //     select_type: 'select2',
                        //     select_type_options: {
                        //       width: '70px'
                        //     },
                        //     filter_default_label: "PDB",
                        //     filter_reset_button_text: false,
                        // },
                        // {
                        //     column_number : 2,
                        //     filter_type: "multi_select",
                        //     select_type: 'select2',
                        //     column_data_type: "html",
                        //     html_data_type: "text",
                        //     filter_default_label: "Receptor",
                        //     filter_match_mode : "exact",
                        //     filter_reset_button_text: false,
                        // },
                        // {
                        //     column_number : 3,
                        //     filter_type: "multi_select",
                        //     select_type: 'select2',
                        //     html_data_type: "text",
                        //     select_type_options: {
                        //       width: '150px'
                        //     },
                        //     filter_default_label: "Family",
                        //     filter_match_mode : "exact",
                        //     filter_reset_button_text: false,
                        // },
                        // {
                        //     column_number : 4,
                        //     filter_type: "multi_select",
                        //     select_type: 'select2',
                        //     filter_default_label: "Species",
                        //     filter_reset_button_text: false,
                        // },
                        // {
                        //     column_number : 5,
                        //     filter_type: "multi_select",
                        //     select_type: 'select2',
                        //     select_type_options: {
                        //         minimumResultsForSearch: -1 // remove search box
                        //     },
                        //     filter_default_label: "State",
                        //     column_data_type: "html",
                        //     html_data_type: "text",
                        //     filter_match_mode : "exact",
                        //     filter_reset_button_text: false,

                        // },
                        // {
                        //     column_number : 6,
                        //     filter_type: "multi_select",
                        //     select_type: 'select2',
                        //     filter_default_label: "Representative",
                        //     filter_reset_button_text: false,

                        // },
                    ],
                    {
                        cumulative_filtering: false
                    }
                );

            yadcf.exResetAllFilters(oTable);

            $('.greyscale').each(function() {
                var s = $(this).html();
                if (s == "-") return
                if (!s) return
                frequency = 0.5-(s/-2)*.5;
                var rgb = { r: 255-frequency*255, g: 255-frequency*255, b: 255-frequency*255 };
                var hex = rgb2hex(rgb.r, rgb.g, rgb.b);
                $(this).attr('bgcolor',hex);
                console.log(s,hex)
            });

        });
        function rgb2hex(r,g,b) {
            r = Math.round(r).toString(16);
            g = Math.round(g).toString(16);
            b = Math.round(b).toString(16);

            if (r.length == 1)
                r = '0' + r;

            if (g.length == 1)
                g = '0' + g;

            if (b.length == 1)
                b = '0' + b;

            return '#' + r + g + b;
        }

        var tableToExcel = (function () {
            var uri = 'data:application/vnd.ms-excel;base64,',
                template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>',
                base64 = function (s) {
                    return window.btoa(unescape(encodeURIComponent(s)))
                }, format = function (s, c) {
                    return s.replace(/{(\w+)}/g, function (m, p) {
                        return c[p];
                    })
                }
            return function (table, name, filename) {
                if (!table.nodeType) table = document.getElementById(table)
                var ctx = {
                    worksheet: name || 'Worksheet',
                    table: table.innerHTML
                }
           document.getElementById("dlink").href = uri + base64(format(template, ctx));
                    document.getElementById("dlink").download = filename;
                    document.getElementById("dlink").click();
            }
        })()
    </script>
{% endblock %}
{% block addon_css %}
    <link rel="stylesheet" href="{% static 'home/css/jquery.dataTables.min.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/yadcf_bootstrap_version.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/select2.css' %}" type="text/css" />
    <style type="text/css">
        #content {
            width: 100%;
        }
        .yadcf-filter-range-date, .yadcf-filter-range-number {
            width: 30px;
            /*font-family: sans-serif;*/
            font-size: 100%;
            /*font-weight: bold;*/
        }
    </style>
{% endblock %}