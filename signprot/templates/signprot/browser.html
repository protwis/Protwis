{% extends "home/base.html" %}
{% load static %}
{% load structure_extras %}

{% block addon_css %}
    <link rel="stylesheet" href="{% static 'home/css/jquery.dataTables.min.css' %}" type="text/css"/>
    <link rel="stylesheet" href="{% static 'home/css/yadcf_bootstrap_version.css' %}" type="text/css"/>
    <link rel="stylesheet" href="{% static 'home/css/select2.css' %}" type="text/css"/>
    <style type="text/css">
        .select2-result-label {
            font-size: x-small;
            font-size: 10px;
        }

        #filters {

            font-size: 10px;
            padding: 7px 15px;
        }

        @media (min-width: 1600px) {
            #content {
                width: 1570px;
            }
        }

        @media (min-width: 1800px) {
            #content {
                width: 1770px;
            }
        }

        table.dataTable.compact thead th.over_header {
            border-right: 1px solid;
            border-left: 0px solid;
            text-align: center;
            padding: 4px 4px 4px 4px;
        }

        table.dataTable.compact thead tr.over_header th {
            border-bottom: 1px solid #ccc;
        }

        table.dataTable.compact thead th.leftborder {
            border-left: 1px solid;
        }

        table.dataTable.compact thead th.rightborder {
            border-right: 1px solid;
        }

        table.dataTable.compact thead th.checkbox_tr {
            text-align: left;
            padding: 4px 4px 4px 4px;
        }

        table.dataTable.compact thead th {
            padding: 4px 16px 4px 2px;
        }

        .yadcf-filter-wrapper {
            margin-top: 0px;
        }

        input.yadcf-filter {
            width: 100px;
            font-family: sans-serif;
            font-size: 100%;
            font-weight: bold;
        }

        .yadcf-filter-range-date, .yadcf-filter-range-number {
            width: 30px;
            font-family: sans-serif;
            font-size: 100%;
            font-weight: bold;
        }

        /*#yadcf-filter--couplings-from-12 {
            width: 10px;
        }
        #yadcf-filter--couplings-to-12 {
            width: 10px;
        }
        .yadcf-filter-wrapper-inner--couplings-12 {
            width: 5px;
        }*/
        .clicked_button {
            background-color: rgb(215, 215, 215);
        }

        .wrapper {
            overflow-x: scroll;
            overflow-y: hidden;
        }

        #overlay {
            top: 0px;
            position: absolute;
            background: #f8f8f8;
            /*border: 1px solid #333;*/
            -webkit-box-shadow: 5px 0 2px -2px #888;
            box-shadow: 5px 0 2px -2px #888;
        }

        #overlay tbody tr {
            background-color: #f8f8f8;
        }

        .highlight {
            background-color: rgb(204, 229, 255);
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f1f1f1;
            width: 100%;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1;
        }

        .dropdown-content p {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            width: 100%;
            display: block;
        }

        .show {
            display: block;
        }

    </style>
{% endblock %}

{% block addon_js %}
    <script src="{% static 'home/js/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'home/js/jquery.dataTables.yadcf.js' %}"></script>
    <script src="{% static 'home/js/select2.js' %}"></script>
    <script src="{% static 'home/js/datatables.min.js' %}"></script>


    <script type="text/javascript" charset="utf-8">
        $(document).ready(function () {
            // 'use strict';

            var oTable = $('#couplings').DataTable({
                "scrollY": $(window).height() - 450,
                "scrollX": true,
                "scrollCollapse": true,
                "scroller": true,
                "paging": false,
                "bSortCellsTop": true, //prevent sort arrows going on bottom row
                "aaSorting": [],
                "autoWidth": true,
                "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                "pageLength": -1,
                //"dom": 'Blfrtip',
                //"buttons": ['copy', 'csv', 'excel'],
                "bInfo": true,
            });

            yadcf.init(oTable,
                [
                    {
                        column_number: 1,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Class",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 2,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Family",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 3,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "uniprot",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 4,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "IUPHAR",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '100px',
                        },
                    },
                    {
                        column_number: 5,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Bouvier",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '60px',
                        },
                    },
                    {
                        column_number: 6,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Inoue",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 7,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Gtp",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 8,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Bouvier",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '60px',
                        },
                    },
                    {
                        column_number: 9,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Inoue",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 10,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "GtP",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 11,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Bouvier",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '60px',
                        },
                    },
                    {
                        column_number: 12,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Inoue",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 13,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "GtP",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 14,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Bouvier",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '60px',
                        },
                    },
                    {
                        column_number: 15,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Inoue",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 16,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Gtp",
                        filter_reset_button_text: false,
                    },
                    {
                        column_number: 17,
                        filter_type: "multi_select",
                        select_type: 'select2',
                        filter_default_label: "Arrestin",
                        filter_reset_button_text: false,
                        select_type_options: {
                            width: '60px',
                        },
                    },
                ],
                {filters_tr_index: 1},
                {
                    cumulative_filtering: true
                }
            );

            yadcf.exResetAllFilters(oTable);


            // By default display the first tab. If this is not on one has to click on the tab for display.
            $('#myTab a:first').tab('show');

            $('#couplings' + ' > tbody > tr').click(function (event) {
                if (event.target.type !== 'checkbox') {
                    $(':checkbox', this).trigger('click');
                    $(this).eq(0).toggleClass('alt_selected');
                    $(this).find('td').toggleClass('highlight');
                }
                $(this).eq(0).toggleClass('alt_selected');
                $(this).find('td').toggleClass('highlight');
            });

            $(".select-all").click(function () {
                $(':checkbox', this).trigger('click');
                if ($(this).prop('checked') === true) {
                    $('.alt').prop('checked', true);
                    $('.alt').parent().parent().addClass('alt_selected');
                    $('.alt').parent().parent().find('td').addClass('highlight');
                }
                if ($(this).prop('checked') === false) {
                    $('.alt').prop('checked', false);
                    $('.alt').parent().parent().removeClass('alt_selected');
                    $('.alt').parent().parent().find('td').removeClass('highlight');
                }
            });

            // $('.wrapper').find('div').width($(".yadcf-datatables-table--couplings").width());

            $('.hide_columns').click(function (evt) {
                var columns = $(this).attr('columns').split(",");
                columns.forEach(function (column) {
                    var column = oTable.column(column);
                    try {
                        column.visible(false, false);
                    } catch (err) {
                        column.visible(false, false);
                    }
                });
                oTable.draw();
            });

            toggle_enabled = true;
            $('#toggle_fixed_btn').click(function () {
                if (toggle_enabled) {
                    toggle_enabled = false;
                    $("#overlay").hide();
                    $("#toggle_fixed_btn").attr('value', "Enable fixed columns");
                    $("#toggle_fixed_btn").addClass('clicked_button');
                } else {
                    toggle_enabled = true;
                    $('.dataTables_scrollBody').scroll();
                    $("#toggle_fixed_btn").attr('value', "Disable fixed columns");
                    $("#toggle_fixed_btn").removeClass('clicked_button');
                }
            });

            $("#toggle_columns_btn").click(function () {
                var columns = Array.from(new Array(24), (x, i) => i + 6);
                columns.forEach(function (column) {
                    var column = oTable.column(column);
                    try {
                        column.visible(true, false);
                    } catch (err) {
                        column.visible(true, false);
                    }
                });
                oTable.draw();
            });

            $('#uniprot_copy').click(function () {
                copyToClipboard('uniprot');
            });

            $('#reset_filters_btn').click(function () {
                window.location.href = '/signprot/'
            });

            $('.dataTables_scrollBody').append('<div id=overlay><table id="overlay_table" ' +
                'class="row-border text-center compact dataTable no-footer text-nowrap"><tbody></tbody></table></div>');

            function create_overlay() {
                // This function fires upon filtering, to update what rows to show as an overlay
                $("#overlay_table tbody tr").remove();
                var $target = $("#overlay_table tbody");
                $("#couplings tbody tr").each(function () {
                    var $tds = $(this).children(),
                        $row = $("<tr></tr>");
                    // $row.append($tds.eq(0).clone()).append($tds.eq(1).clone()).appendTo($target);
                    $row.append($tds.eq(1).clone()).append($tds.eq(2).clone()).appendTo($target);
                    $row.height($(this).height());
                });
                $("#overlay_table .border-right").removeClass("border-right");
            }

            // Function that detects filtering events
            $('#couplings').on('draw.dt', function (e, oSettings) {
                create_overlay();
            });

            create_overlay();
            $("#overlay").hide();

            var left = 0;
            var old_left = 0;
            toggle_enabled = true;
            $('.dataTables_scrollBody').scroll(function () {
                // If user scrolls and it's >100px from left, then attach fixed columns overlay
                left = $('.dataTables_scrollBody').scrollLeft();
                if (left != old_left) $("#overlay").hide();
                old_left = left;

                if (left > 100 && toggle_enabled) {
                    $("#overlay").css({left: left + 'px'});
                    if ($("#overlay").is(":hidden")) $("#overlay").show();
                }
            });
            // console.log($('#yadcf-filter--couplings-from-12').width());
            // $('#yadcf-filter--couplings-from-12').width(10);
            // console.log($('#yadcf-filter--couplings-from-12').width());

        });

        var tableToExcel = (function () {
            var uri = 'data:application/vnd.ms-excel;base64,',
                template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" ' +
                    'xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>',
                base64 = function (s) {
                    return window.btoa(unescape(encodeURIComponent(s)))
                }, format = function (s, c) {
                    return s.replace(/{(\w+)}/g, function (m, p) {
                        return c[p];
                    })
                }
            return function (table, name, filename) {
                var table = $("#" + table).clone();
                $("#excel_table").html(table);
                // Clean up table to remove yadcf stuff
                $("#excel_table thead tr").css('height', '');
                $("#excel_table thead th").css('height', '');
                $("#excel_table thead div").css('height', '');
                $("#excel_table thead .yadcf-filter-wrapper").remove();
                $("#excel_table thead button").remove();
                var tr = $("#excel_table thead tr:eq(1)");
                // reattach th titles
                tr.find('th').each(function (column, th) {
                    if ($(th).attr('title')) $(th).html($(th).attr('title'));
                });

                var ctx = {
                    worksheet: name || 'Worksheet',
                    table: $("#excel_table").html()
                }
                $("#excel_table").html("");
                document.getElementById("dlink").href = uri + base64(format(template, ctx));
                document.getElementById("dlink").download = filename;
                document.getElementById("dlink").click();
            }
        })()

        function copyDropdown() {
            document.getElementById("Dropdown").classList.toggle("show");
        }

        window.onclick = function (event) {
            if (!event.target.matches('.dropbtn')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                var i;
                for (i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        function copyToClipboard(data) {
            var link = $('.alt_selected > .' + data + ' > a');
            var out = [];
            link.each(function () {
                var ele = $(this).attr('href').split('/');
                out.push(ele[ele.length - 1])
            });
            console.log(out);
            if (out.length === 0) {
                window.alert('No entries selected for copying')
                return 0
            }
            var textArea = document.createElement("textarea");
            textArea.value = out;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            var successful = document.execCommand('copy');
            document.body.removeChild(textArea);
        }

    </script>
{% endblock %}

{% block content %}
    <div id="browser">
        <div style="display:block;">
            <div style="display:inline; float:left;">
                <h2 style="width:auto; display:inline;">Couplings</h2>
            </div>
        </div>
        <br>
        <br>

        <div style='width:100%; display:inline;'>
            <div class="btn-group">
                <a id="dlink" style="display:none;"></a>
                <div id="excel_table" style2="display:none;"></div>
                <input class="btn btn-default btn-s" type="button" id="toggle_fixed_btn" value="Disable fixed columns"
                       href="javascript:void(0)" data-toggle="buttons">
                <input class="btn btn-default btn-s" type="button" id="toggle_columns_btn" value="Show hidden columns"
                       href="javascript:void(0)">
            </div>
            <div class="btn-group" style='padding-left:10px;'>
                <input class="btn btn-default btn-s" type="button"
                       onclick="tableToExcel('couplings', 'Coupling data', 'GPCRdb_coupling.xls')"
                       value="Export Excel">
                <div class="dropdown">
                    <button onclick="copyDropdown()" class="dropbtn btn btn-default btn-s">Copy Selected</button>
                    <div id="Dropdown" class="dropdown-content">
                        <p class="btn btn_default btn-s" type="button" id="uniprot_copy">uniprot</p>
                    </div>
                </div>
                <label class="btn btn-default btn-s" id="reset_filters_btn" href="javascript:void(0)">
                    Reset All
                </label>
                <!-- PDB-search box
                <div style="float:right;">
                    <input id="filter_input" placeholder="PDBs/UniProts..."></input>
                    <label class="btn btn-default btn-s" id="filter_button" href="javascript:void(0)">
                        <i class="glyphicon glyphicon-search"></i>
                    </label>
                </div>
                -->
            </div>
        </div>
        <br>

        <!-- scrollable column -->
        <div style='padding-top: 0px; font-size: 10px; white-space: nowrap; width:100%; overflow-y:hidden; display:inline-block; width:100%;'>
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="families-tab" data-toggle="tab" href="#families" role="tab"
                       aria-controls="families" aria-selected="true">Families</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="subtypes-tab" data-toggle="tab" href="#subtypes" role="tab"
                       aria-controls="subtypes" aria-selected="false">Subtypes</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="bouvier-tab" data-toggle="tab" href="#bouvier" role="tab"
                       aria-controls="bouvier" aria-selected="false">Bouvier</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="inoue-tab" data-toggle="tab" href="#inoue" role="tab"
                       aria-controls="inoue" aria-selected="false">Inoue</a>
                </li>
            </ul>

            <div class="tab-content" id="myTabContent">
                <div id='couplings_div'>
                    <div class="tab-pane fade active show" id="families" role="tabpanel" aria-labelledby="families-tab">
                        <table width="100%" class="display compact text-nowrap" id='couplings'>
                            <thead>
                            <tr class='over_header over_header_row'>
                                <th colspan=5 class="over_header" style='height:35px; text-align:left;'>
                                    RECEPTOR
                                </th>
                                <th colspan=3 class="over_header flexible_over_header" style='text-align:left;'>
                                    Gs
                                    <button type="button" class="close hide_columns" columns="5,6,7"
                                            style="float:right;display:inline;" aria-label="Close"><span aria-hidden="true">&times;</span>
                                    </button>
                                </th>
                                <th colspan=3 class="over_header flexible_over_header" style='text-align:left;'>
                                    Gi/o
                                    <button type="button" class="close hide_columns" columns="8,9,10"
                                            style="float:right;display:inline;" aria-label="Close"><span aria-hidden="true">&times;</span>
                                    </button>
                                </th>
                                <th colspan=3 class="over_header flexible_over_header" style='text-align:left;'>
                                    Gq/11
                                    <button type="button" class="close hide_columns" columns="11,12,13"
                                            style="float:right;display:inline;" aria-label="Close"><span aria-hidden="true">&times;</span>
                                    </button>
                                </th>
                                <th colspan=3 class="over_header flexible_over_header" style='text-align:left;'>
                                    G12/13
                                    <button type="button" class="close hide_columns" columns="14,15,16"
                                            style="float:right;display:inline;" aria-label="Close"><span aria-hidden="true">&times;</span>
                                    </button>
                                </th>
                                <th colspan=1 style='text-align:left;'>
                                    Arrestin
                                    <button type="button" class="close hide_columns" columns="17" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </th>
                            </tr>
                            <tr>
                                <th class='no-sort checkbox_tr'><input class="select-all" type="checkbox"
                                                                       onclick="select_all(this)"></th>
                                <th title="Class" style='height: 70px;'></th>
                                <th title="Family"></th>
                                <th title="uniprot"></th>
                                <th title="IUPHAR" class='rightborder'></th>
                                <th title="Bouvier"></th>
                                <th title="Inoue"></th>
                                <th title="GtP" class='rightborder'></th>
                                <th title="Bouvier"></th>
                                <th title="Inoue"></th>
                                <th title="GtP" class='rightborder'></th>
                                <th title="Bouvier"></th>
                                <th title="Inoue"></th>
                                <th title="GtP" class='rightborder'></th>
                                <th title="Bouvier"></th>
                                <th title="Inoue"></th>
                                <th title="GtP" class='rightborder'></th>
                                <th title="Bouvier"></th>
                            </tr>

                            </thead>
                            <tbody>
                            {% for p, vals in data.items %}
                                <tr>
                                    <td class="text-center"><input class="alt" type="checkbox" id="{{ vals.3 }}"></td>
                                    <td class="text-left">{{ vals.0 }}</td>
                                    <td class="text-left">{{ vals.1 }}</td>
                                    <td class="uniprot">
                                        <span><a href="http://www.uniprot.org/uniprot/{{ vals.2 }}">{{ vals.3 }}</a></span>
                                    </td>
                                    <td class="text-left">{{ vals.4|safe }}</td>
                                    <td class="text-center">{{ vals.pk }}</td>
                                    <td class="text-center">{{ vals.17 }}</td>
                                    <td class="text-center">{{ vals.9 }}</td>
                                    <td class="text-center">{{ vals.pk }}</td>
                                    <td class="text-center">{{ vals.19 }}</td>
                                    <td class="text-center">{{ vals.10 }}</td>
                                    <td class="text-center">{{ vals.pk }}</td>
                                    <td class="text-center">{{ vals.23 }}</td>
                                    <td class="text-center">{{ vals.11 }}</td>
                                    <td class="text-center">{{ vals.pk }}</td>
                                    <td class="text-center">{{ vals.11 }}</td>
                                    <td class="text-center">{{ vals.26 }}</td>
                                    <td class="text-center">{{ vals.11 }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="subtypes" role="tabpanel" aria-labelledby="subtypes-tab">
                        <h2>Soon Content Here</h2>
                    </div>
                    <div class="tab-pane fade" id="bouvier" role="tabpanel" aria-labelledby="bouvier-tab">
                        <h2>Soon Content Here</h2>
                    </div>
                    <div class="tab-pane fade" id="inoue" role="tabpanel" aria-labelledby="inoue-tab">
                        <h2>Soon Content Here</h2>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}


